name: Build and Publish NuGet Package

on:
  push:
    tags:
      - 'v*.*.*'      # Publish only on version tags like v1.0.0
  workflow_dispatch:   # Allow manual runs

env:
  ORT_VERSION: "1.22.0"
  DOTNET_VERSION: "9.0.x"

jobs:

  #######################################################################
  #  L I N U X
  #######################################################################
  build-linux:
    runs-on: ubuntu-latest
    outputs:
      linux-path: dotnet/MagikaSharp/runtimes/linux-x64/native/
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - run: rustup target add x86_64-unknown-linux-musl

      - name: Download ONNX Runtime (Linux)
        run: |
          mkdir -p rust/magika_ffi/ort
          cd rust/magika_ffi/ort
          wget -q https://github.com/microsoft/onnxruntime/releases/download/v${{ env.ORT_VERSION }}/onnxruntime-linux-x64-${{ env.ORT_VERSION }}.tgz
          tar xf onnxruntime-linux-x64-${{ env.ORT_VERSION }}.tgz

      - name: Set ORT paths
        run: |
          echo "ORT_LIB_LOCATION=${{ github.workspace }}/rust/magika_ffi/ort/onnxruntime-linux-x64-${{ env.ORT_VERSION }}/lib" >> $GITHUB_ENV
          echo "ORT_INCLUDE_LOCATION=${{ github.workspace }}/rust/magika_ffi/ort/onnxruntime-linux-x64-${{ env.ORT_VERSION }}/include" >> $GITHUB_ENV

      - name: Build Rust (Linux)
        working-directory: rust/magika_ffi
        run: cargo build --release --target x86_64-unknown-linux-gnu

      - name: Copy Linux runtimes
        run: |
          mkdir -p dotnet/MagikaSharp/runtimes/linux-x64/native
          cp rust/magika_ffi/target/x86_64-unknown-linux-gnu/release/libmagika_ffi.so dotnet/MagikaSharp/runtimes/linux-x64/native/
          cp rust/magika_ffi/ort/onnxruntime-linux-x64-${{ env.ORT_VERSION }}/lib/libonnxruntime.so* dotnet/MagikaSharp/runtimes/linux-x64/native/

      - uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: dotnet/MagikaSharp/runtimes/linux-x64/native/



  #######################################################################
  #  W I N D O W S
  #######################################################################
  build-windows:
    runs-on: windows-latest
    outputs:
      windows-path: dotnet/MagikaSharp/runtimes/win-x64/native/
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - run: rustup target add x86_64-pc-windows-msvc

      - name: Download ONNX Runtime (Windows)
        run: |
          mkdir rust\magika_ffi\ort
          cd rust\magika_ffi\ort
          Invoke-WebRequest https://github.com/microsoft/onnxruntime/releases/download/v${{ env.ORT_VERSION }}/onnxruntime-win-x64-${{ env.ORT_VERSION }}.zip -OutFile ort.zip
          Expand-Archive ort.zip -DestinationPath .

      - name: Set ORT paths
        run: |
          echo "ORT_LIB_LOCATION=${{ github.workspace }}\\rust\\magika_ffi\\ort\\onnxruntime-win-x64-${{ env.ORT_VERSION }}\\lib" >> $env:GITHUB_ENV
          echo "ORT_INCLUDE_LOCATION=${{ github.workspace }}\\rust\\magika_ffi\\ort\\onnxruntime-win-x64-${{ env.ORT_VERSION }}\\include" >> $env:GITHUB_ENV

      - name: Build Rust (Windows)
        working-directory: rust/magika_ffi
        run: cargo build --release --target x86_64-pc-windows-msvc

      - name: Copy Windows runtimes
        run: |
          mkdir dotnet\MagikaSharp\runtimes\win-x64\native
          copy rust\magika_ffi\target\x86_64-pc-windows-msvc\release\magika_ffi.dll dotnet\MagikaSharp\runtimes\win-x64\native\
          copy rust\magika_ffi\ort\onnxruntime-win-x64-${{ env.ORT_VERSION }}\lib\onnxruntime.dll dotnet\MagikaSharp\runtimes\win-x64\native\

      - uses: actions/upload-artifact@v4
        with:
          name: win-x64
          path: dotnet/MagikaSharp/runtimes/win-x64/native/



  #######################################################################
  #  M A C O S   (ARM64)
  #######################################################################
  build-macos:
    runs-on: macos-latest
    outputs:
      macos-path: dotnet/MagikaSharp/runtimes/osx-arm64/native/
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - run: rustup target add aarch64-apple-darwin

      - name: Download ONNX Runtime (macOS ARM64)
        run: |
          mkdir -p rust/magika_ffi/ort
          cd rust/magika_ffi/ort
          wget -q https://github.com/microsoft/onnxruntime/releases/download/v${{ env.ORT_VERSION }}/onnxruntime-osx-arm64-${{ env.ORT_VERSION }}.tgz
          tar xf onnxruntime-osx-arm64-${{ env.ORT_VERSION }}.tgz

      - name: Set ORT paths
        run: |
          echo "ORT_LIB_LOCATION=${{ github.workspace }}/rust/magika_ffi/ort/onnxruntime-osx-arm64-${{ env.ORT_VERSION }}/lib" >> $GITHUB_ENV
          echo "ORT_INCLUDE_LOCATION=${{ github.workspace }}/rust/magika_ffi/ort/onnxruntime-osx-arm64-${{ env.ORT_VERSION }}/include" >> $GITHUB_ENV

      - name: Build Rust (macOS ARM64)
        working-directory: rust/magika_ffi
        run: cargo build --release --target aarch64-apple-darwin

      - name: Copy macOS runtimes
        run: |
          mkdir -p dotnet/MagikaSharp/runtimes/osx-arm64/native
          cp rust/magika_ffi/target/aarch64-apple-darwin/release/libmagika_ffi.dylib dotnet/MagikaSharp/runtimes/osx-arm64/native/
          find rust/magika_ffi/ort/onnxruntime-osx-arm64-${{ env.ORT_VERSION }}/lib \
            -maxdepth 1 -type f -name "*.dylib" \
            -exec cp {} dotnet/MagikaSharp/runtimes/osx-arm64/native/ \;

      - uses: actions/upload-artifact@v4
        with:
          name: osx-arm64
          path: dotnet/MagikaSharp/runtimes/osx-arm64/native/



  #######################################################################
  #  N U G E T   P U B L I S H
  #######################################################################
  publish-nuget:
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: linux-x64
          path: dotnet/MagikaSharp/runtimes/linux-x64/native/

      - uses: actions/download-artifact@v4
        with:
          name: win-x64
          path: dotnet/MagikaSharp/runtimes/win-x64/native/

      - uses: actions/download-artifact@v4
        with:
          name: osx-arm64
          path: dotnet/MagikaSharp/runtimes/osx-arm64/native/

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Build .NET project
        working-directory: dotnet/MagikaSharp
        run: dotnet build -c Release

      - name: Pack NuGet
        working-directory: dotnet/MagikaSharp
        run: dotnet pack -c Release

      - name: Publish NuGet
        working-directory: dotnet/MagikaSharp
        run: dotnet nuget push "bin/Release/*.nupkg" --source https://api.nuget.org/v3/index.json --api-key ${{ secrets.NUGET_API_KEY }} --skip-duplicate
